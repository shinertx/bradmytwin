<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Brad.com</title>
    <script src="/config.js"></script>
    <style>
      :root { --bg: #f4efe6; --ink: #17212d; --card: #fffaf2; --accent: #c45522; --line: #d9c8b0; }
      body { margin: 0; font-family: "Avenir Next", "Segoe UI", sans-serif; background: radial-gradient(circle at 20% 0%, #fff3d9, var(--bg)); color: var(--ink); }
      .wrap { max-width: 980px; margin: 32px auto; padding: 0 16px; }
      .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
      .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 16px; box-shadow: 0 12px 30px rgba(40, 22, 8, 0.08); }
      h1 { margin: 0 0 10px; font-size: 30px; }
      h2 { margin: 0 0 8px; font-size: 18px; }
      input, button, textarea { width: 100%; box-sizing: border-box; padding: 10px; border-radius: 8px; border: 1px solid #cbb69b; font-size: 14px; }
      button { background: var(--accent); color: #fff; border: 0; cursor: pointer; margin-top: 8px; }
      button.secondary { background: #3b5b6f; }
      #chatLog { max-height: 340px; overflow-y: auto; background: #fff; border: 1px solid var(--line); border-radius: 8px; padding: 8px; }
      .msg { margin: 8px 0; padding: 8px; border-radius: 8px; }
      .in { background: #e8f2f9; }
      .out { background: #f9efe4; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; font-size: 12px; word-break: break-all; }
      .row { display: flex; gap: 8px; }
      .row > * { flex: 1; }
      @media (max-width: 640px) { .wrap { margin: 18px auto; } h1 { font-size: 24px; } }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Brad.com</h1>
      <p>Phone-anchored Digital Twin across SMS, WhatsApp, Telegram, and Web.</p>
      <div class="grid">
        <section class="card">
          <h2>Phone OTP Login</h2>
          <input id="phone" placeholder="+15551234567" />
          <button id="startOtp">Send OTP</button>
          <input id="otp" placeholder="6-digit code" />
          <button id="verifyOtp">Verify and Sign In</button>
          <p id="authState" class="mono"></p>
        </section>
        <section class="card">
          <h2>Connectors</h2>
          <button id="connectCalendar" class="secondary">Connect Google Calendar</button>
          <button id="connectEmail" class="secondary">Connect Gmail</button>
          <p id="connectorState" class="mono"></p>
        </section>
      </div>
      <div class="grid" style="margin-top: 16px;">
        <section class="card">
          <h2>Web Chat</h2>
          <div id="chatLog"></div>
          <textarea id="chatInput" rows="3" placeholder="Message your twin"></textarea>
          <button id="sendChat">Send</button>
        </section>
        <section class="card">
          <h2>Approvals</h2>
          <button id="loadApprovals" class="secondary">Refresh Approvals</button>
          <div id="approvals" class="mono"></div>
        </section>
      </div>
    </div>

    <script>
      const api = window.__BRAD_CONFIG__.API_BASE_URL;
      let token = localStorage.getItem('brad_token') || '';

      const authState = document.getElementById('authState');
      const connectorState = document.getElementById('connectorState');
      const chatLog = document.getElementById('chatLog');

      function setState(el, text) { el.textContent = text; }
      function authHeader() { return token ? { Authorization: `Bearer ${token}` } : {}; }

      async function call(path, options = {}) {
        const res = await fetch(`${api}${path}`, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            ...(options.headers || {}),
            ...authHeader()
          }
        });
        const text = await res.text();
        try { return { ok: res.ok, data: JSON.parse(text) }; } catch { return { ok: res.ok, data: text }; }
      }

      document.getElementById('startOtp').onclick = async () => {
        const phone = document.getElementById('phone').value.trim();
        const out = await call('/auth/otp/start', { method: 'POST', body: JSON.stringify({ phone }) });
        setState(authState, JSON.stringify(out.data));
      };

      document.getElementById('verifyOtp').onclick = async () => {
        const phone = document.getElementById('phone').value.trim();
        const code = document.getElementById('otp').value.trim();
        const out = await call('/auth/otp/verify', { method: 'POST', body: JSON.stringify({ phone, code }) });
        if (out.ok && out.data.token) {
          token = out.data.token;
          localStorage.setItem('brad_token', token);
        }
        setState(authState, JSON.stringify(out.data));
      };

      document.getElementById('sendChat').onclick = async () => {
        const text = document.getElementById('chatInput').value.trim();
        if (!text) return;
        await call('/web/chat/messages', { method: 'POST', body: JSON.stringify({ text }) });
        document.getElementById('chatInput').value = '';
      };

      async function refreshChat() {
        if (!token) return;
        const res = await fetch(`${api}/web/chat/stream`, { headers: authHeader() });
        if (!res.ok) return;
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          buffer += decoder.decode(value, { stream: true });
          const chunks = buffer.split('\n\n');
          buffer = chunks.pop() || '';
          for (const chunk of chunks) {
            const line = chunk.split('\n').find((l) => l.startsWith('data: '));
            if (!line) continue;
            try {
              const messages = JSON.parse(line.slice(6));
              chatLog.innerHTML = messages.map((m) => `<div class="msg ${m.direction === 'INBOUND' ? 'in' : 'out'}"><strong>${m.direction}</strong> (${m.channel})<br>${m.body}</div>`).join('');
              chatLog.scrollTop = chatLog.scrollHeight;
            } catch {}
          }
        }
      }

      document.getElementById('loadApprovals').onclick = async () => {
        const out = await call('/approvals');
        document.getElementById('approvals').textContent = JSON.stringify(out.data, null, 2);
      };

      document.getElementById('connectCalendar').onclick = async () => {
        const out = await call('/auth/link/google/start', { method: 'POST', body: JSON.stringify({ scope: 'calendar' }) });
        setState(connectorState, JSON.stringify(out.data));
        if (out.ok && out.data.authUrl) window.open(out.data.authUrl, '_blank');
      };

      document.getElementById('connectEmail').onclick = async () => {
        const out = await call('/auth/link/google/start', { method: 'POST', body: JSON.stringify({ scope: 'email' }) });
        setState(connectorState, JSON.stringify(out.data));
        if (out.ok && out.data.authUrl) window.open(out.data.authUrl, '_blank');
      };

      setInterval(refreshChat, 5000);
      refreshChat();
    </script>
  </body>
</html>
